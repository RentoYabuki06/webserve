## ⏱️ 1時間以内に終わる超細分化タスク

> 各タスクは独立して約20–60分で完了する粒度です。順番に消化すればMandatory達成まで到達できます。

---

### フェーズ1: 最小サーバーの骨組み

- [ ] **Makefileの雛形**
  - **目的**: `c++ -Wall -Wextra -Werror -std=c++98` でビルドできる
  - **手順**: 変数 `NAME`, ルール `all/clean/fclean/re`、依存の自動再ビルド
  - **Done**: `make && ./webserv` が（まだ何もしなくても）起動
  - **時間**: 20–30分

- [ ] **ロガー（簡易）**
  - **目的**: 進捗とエラーを標準出力/標準エラーに整形出力
  - **手順**: `Log::info/warn/error` の静的関数
  - **Done**: 主要イベントでログが出る
  - **時間**: 20–30分

- [ ] **ソケット作成・非ブロッキング化**
  - **目的**: `socket/bind/listen` と `fcntl(O_NONBLOCK)` を適用
  - **手順**: ポートは固定値(例: 8080)でOK
  - **Done**: 起動時に「Listening on :8080」とログ
  - **時間**: 30–45分

- [ ] **poll()ループの骨格**
  - **目的**: 単一のイベントループで監視
  - **手順**: 監視対象に「リッスンFD(読取)」を追加、`poll()` の戻りで分岐
  - **Done**: ループが回り続ける（CPU暴走しない）
  - **時間**: 30–45分

- [ ] **accept() と接続FD管理**
  - **目的**: 新規接続を非ブロッキングFDで登録
  - **手順**: 接続ごとに構造体 `Conn` を作って `pollfds` に追加（R/W同時監視）
  - **Done**: 接続時にログ、切断でFD解放
  - **時間**: 30–45分

---

### フェーズ2: GETの最小レスポンス

- [ ] **受信バッファの実装（行単位で溜める）**
  - **目的**: `recv` の断片を貯めて `\r\n\r\n` まで検出
  - **手順**: 文字列バッファ & 状態 `READING_HEADERS`
  - **Done**: ヘッダ終端を検出して次状態へ
  - **時間**: 30–45分

- [ ] **リクエストラインのパース**
  - **目的**: `METHOD PATH HTTP/1.1` を分解
  - **手順**: `space` 区切り、メソッドは列挙型に
  - **Done**: `GET / HTTP/1.1` を正しく保持
  - **時間**: 20–30分

- [ ] **ヘッダのパース（最小）**
  - **目的**: `Host`, `Connection` 程度を連想配列へ
  - **手順**: `:` 区切り、キーを小文字正規化
  - **Done**: `headers["host"]` で参照可
  - **時間**: 30–40分

- [ ] **固定文字列レスポンス200**
  - **目的**: レスポンス生成と送信の流れを固める
  - **手順**: `HTTP/1.1 200 OK\r\nContent-Length:...\r\n\r\nHello`
  - **Done**: `curl localhost:8080` で応答が返る
  - **時間**: 20–30分

- [ ] **送信バッファ & 送信完了管理**
  - **目的**: `send` の部分書きに対応（poll経由のみ）
  - **手順**: `Conn` に `write_buf` と `write_offset`
  - **Done**: 大きなレスポンスでも送信完了まで閉じない
  - **時間**: 30–45分

---

### フェーズ3: 静的ファイル配信

- [ ] **パス解決（簡易root固定）**
  - **目的**: `/path` → `./www/path` にマップ
  - **手順**: 先頭の `/` 除去、`..` の拒否（ディレクトリトラバーサ対策）
  - **Done**: `GET /index.html` が `www/index.html` を探す
  - **時間**: 30–45分

- [ ] **ファイル読み込みとContent-Length**
  - **目的**: `stat` → `open/read` でボディ生成
  - **手順**: バイナリ対応、巨大ファイルは分割送信（後回しで可）
  - **Done**: 実ファイルが返る
  - **時間**: 30–45分

- [ ] **MIMEタイプの最小マップ**
  - **目的**: `.html/.css/.js/.png/.jpg` 程度を判別
  - **手順**: 拡張子→`Content-Type` のテーブル
  - **Done**: `curl -I` で適切なTypeが付与
  - **時間**: 20–30分

- [ ] **404/403の基本応答**
  - **目的**: 存在しない/拒否時に正しいコード
  - **手順**: 短いデフォルトHTMLを返す
  - **Done**: `curl -i /nope` → 404
  - **時間**: 20–30分

---

### フェーズ4: POST（アップロード最小）

- [ ] **Content-Length受信（ヘッダ）**
  - **目的**: ボディ長を取得し状態 `READING_BODY` へ
  - **手順**: 数値パースと上限(暫定)チェック
  - **Done**: 既知サイズの読み込みループが完成
  - **時間**: 30–40分

- [ ] **ボディ保存（単純アップロード）**
  - **目的**: 固定パス `./uploads/` に保存
  - **手順**: ファイル名は時刻＋乱数などで安全に
  - **Done**: `curl -X POST --data-binary @file` で保存
  - **時間**: 30–45分

- [ ] **201 Created とロケーション**
  - **目的**: 成功時に201と保存先を返す
  - **手順**: `Location` ヘッダ付与
  - **Done**: `curl -i` で201/Location表示
  - **時間**: 20–30分

---

### フェーズ5: DELETE（最小）

- [ ] **削除対象の安全な解決**
  - **目的**: ルート外パス拒否、ディレクトリ拒否
  - **手順**: 正規化後に `root` 配下か確認
  - **Done**: `DELETE /file` でファイルのみ削除
  - **時間**: 30–40分

- [ ] **ステータスの分岐**
  - **目的**: 成功 200/204、存在なし 404、権限 403
  - **手順**: `unlink` の戻りで分岐
  - **Done**: `curl -X DELETE` で期待通り
  - **時間**: 20–30分

---

### フェーズ6: 設定ファイル（NGINX風の最小）

- [ ] **構造体設計（Config/Server/Location）**
  - **目的**: `server`, `listen`, `root`, `error_page`, `location` 等
  - **手順**: 最小キーのみに絞る
  - **Done**: 空の構造体でビルド通る
  - **時間**: 30–40分

- [ ] **トークナイザ（空白/波括弧/セミコロン）**
  - **目的**: `server { listen 8080; }` をトークン列へ
  - **手順**: 文字単位で簡易スキャナ
  - **Done**: 単体テストでトークン列確認
  - **時間**: 40–60分

- [ ] **最小パーサ（再帰下降）**
  - **目的**: `server` ブロックと中のディレクティブを構築体へ
  - **手順**: 失敗時は行番号付きエラー
  - **Done**: サンプル設定が読み込める
  - **時間**: 40–60分

- [ ] **複数ポートのlisten生成**
  - **目的**: `listen 8080; listen 8081;` 対応
  - **手順**: ソケットを配列管理しpollへ登録
  - **Done**: 両ポートで応答
  - **時間**: 30–45分

- [ ] **server_nameとデフォルトサーバ**
  - **目的**: Hostヘッダで仮想ホスト振り分け
  - **手順**: 該当なしは最初のserverをデフォルト
  - **Done**: 異なるHostで別rootを返す
  - **時間**: 30–45分

- [ ] **locationのメソッド制限/リダイレクト**
  - **目的**: `allow_methods` と `return 301 URL`
  - **手順**: マッチ順序は最長一致で簡易実装
  - **Done**: 禁止メソッドで405、301が機能
  - **時間**: 40–60分

- [ ] **index と autoindex（簡易）**
  - **目的**: ディレクトリにアクセス時 index、無ければautoindex可
  - **手順**: `readdir` で簡易HTML生成
  - **Done**: `/dir/` で一覧表示
  - **時間**: 40–60分

---

### フェーズ7: CGI（最小動作）

- [ ] **CGI起動の配線（拡張子マップ）**
  - **目的**: `.php` や `.py` に対してCGIを選択
  - **手順**: `Location` に `cgi_pass` 風の設定
  - **Done**: 対象パスでCGI起動に分岐
  - **時間**: 30–45分

- [ ] **環境変数と引数の整備**
  - **目的**: `REQUEST_METHOD`, `CONTENT_LENGTH`, `QUERY_STRING`,
            `SCRIPT_FILENAME`, `PATH_INFO`, `SERVER_PROTOCOL`, `REMOTE_ADDR` 等
  - **手順**: 最小セットから
  - **Done**: CGI側で環境が取得できる
  - **時間**: 40–60分

- [ ] **fork/execve + pipe + poll**
  - **目的**: 親→子(STDIN), 子→親(STDOUT) を非ブロッキングで
  - **手順**: `poll` で両方向監視、書き切り/読み切り管理
  - **Done**: 短いCGIが応答を返す
  - **時間**: 40–60分

- [ ] **CGIヘッダの取り込み**
  - **目的**: CGI出力の `Status`, `Content-Type`, 空行以降をボディに
  - **手順**: 空行までをヘッダとして解釈、無ければ200既定
  - **Done**: `Content-Type:text/html` が反映
  - **時間**: 30–45分

---

### フェーズ8: Chunked と制限・タイムアウト

- [ ] **chunked デコーダ（受信）**
  - **目的**: 16進サイズ→チャンク本文→CRLF の繰り返しを追う
  - **手順**: 状態機械で実装、拡張は無視
  - **Done**: `Transfer-Encoding: chunked` のPOSTが素体に復元
  - **時間**: 40–60分

- [ ] **client_max_body_size**
  - **目的**: 設定値超過で 413 を返す
  - **手順**: Content-Length も chunked 復元後の合計でも判定
  - **Done**: 大きなPOSTが即座に拒否される
  - **時間**: 20–30分

- [ ] **接続/読み書きタイムアウト**
  - **目的**: ハング防止
  - **手順**: `last_activity_at` と `now()` で `408`/切断
  - **Done**: 放置接続を掃除
  - **時間**: 30–45分

---

### フェーズ9: エラー頁とブラウザ/NGINX比較

- [ ] **デフォルトエラーページ整備**
  - **目的**: 400/403/404/405/413/500/502/504 など
  - **手順**: シンプルHTMLテンプレを用意
  - **Done**: すべての経路で人間可読のエラー
  - **時間**: 30–45分

- [ ] **ブラウザ/`curl`/`ab` での確認**
  - **目的**: 基本動作とKeep-Alive
  - **手順**: シナリオ表に沿って実行＆記録
  - **Done**: 期待レスポンスと一致
  - **時間**: 30–45分

- [ ] **NGINXとの挙動比較（ピンポイント）**
  - **目的**: ヘッダとコードを数ケースで比較
  - **手順**: 同一ドキュメント/設定で差分確認
  - **Done**: 主要ケースが同等
  - **時間**: 40–60分

---

### フェーズ10: 安定化（クラッシュ・リークなし）

- [ ] **例外/エラー経路の一掃**
  - **目的**: 失敗時も落ちずに適切応答
  - **手順**: すべての`syscall`戻り値を確認
  - **Done**: フェイルセーフでログに記録
  - **時間**: 40–60分

- [ ] **メモリリークチェック**
  - **目的**: 終了時リークゼロ
  - **手順**: Valgrind 等（Macは代替ツール）
  - **Done**: 主要経路でリークなし
  - **時間**: 40–60分

---

### フェーズ11: 補強 / 推奨タスク（品質・互換性向上）

- [ ] **Keep-Alive & 複数リクエスト処理**
  - **目的**: 1接続で連続したHTTP/1.1リクエストを処理しパイプライン準備
  - **手順**: レスポンス送信完了後バッファ再利用 / Connectionヘッダ判定
  - **Done**: `curl --keepalive-time` 等で複数GETが1接続
  - **時間**: 40–60分

- [ ] **ヘッダ総量 / 行長制限**
  - **目的**: DoS回避 (例: ヘッダ全体64KB, 1行8KB)
  - **手順**: 受信中サイズ超過で 400 or 431
  - **Done**: 超過テストで即エラー
  - **時間**: 20–30分

- [ ] **必須レスポンスヘッダ(Date/Connection/Server)**
  - **目的**: RFC整合の最低限ヘッダ付与
  - **手順**: 共通ビルダで自動挿入
  - **Done**: 任意レスポンスに共通ヘッダ確認
  - **時間**: 20–30分

- [ ] **CGI環境変数拡充**
  - **目的**: PHP等が期待する標準CGI変数追加
  - **手順**: SERVER_NAME/PORT, SCRIPT_NAME, GATEWAY_INTERFACE, CONTENT_TYPE, REDIRECT_STATUS 等
  - **Done**: 簡易phpinfoで表示
  - **時間**: 30–45分

- [ ] **CGIプロセス管理(タイムアウト/上限)**
  - **目的**: ハングCGI抑止とfork濫用防止
  - **手順**: 起動数上限, 秒数超過で kill, waitpid 非ブロッキング
  - **Done**: 無限ループCGIが規定時間で終了
  - **時間**: 40–60分

- [ ] **error_page ディレクティブ実装**
  - **目的**: 特定ステータスにカスタム静的ファイル
  - **手順**: server/location単位マッピング
  - **Done**: 404時に設定ファイル提供
  - **時間**: 30–45分

- [ ] **location root 上書き & 継承**
  - **目的**: server root と location root の適切適用
  - **手順**: パス結合/二重スラッシュ除去
  - **Done**: location毎に差別ルート配信
  - **時間**: 30–40分

- [ ] **パス正規化 & シンボリックリンク対策**
  - **目的**: ディレクトリトラバーサ/リンク抜け防止
  - **手順**: realpath(一時)でroot prefix検証, `..` 除去
  - **Done**: 悪意パス排除
  - **時間**: 30–45分

- [ ] **ディレクトリ末尾スラッシュリダイレクト**
  - **目的**: `/dir` → `/dir/` 301
  - **手順**: statでディレクトリ & 末尾不一致
  - **Done**: ブラウザの相対リンク正常化
  - **時間**: 20–30分

- [ ] **405 Allow ヘッダ出力**
  - **目的**: 禁止メソッド応答でRFC準拠
  - **手順**: location/server設定からAllow生成
  - **Done**: 405レスポンスにAllow表示
  - **時間**: 15–25分

- [ ] **DELETE エラー詳細マッピング**
  - **目的**: errno別 403/404/500 適用
  - **手順**: unlink失敗時switch
  - **Done**: EACCES→403, ENOENT→404
  - **時間**: 15–25分

- [ ] **巨大静的ファイル分割/ゼロコピー**
  - **目的**: メモリ効率向上
  - **手順**: statサイズ閾値超で分割read or sendfile
  - **Done**: >10MBでも常用メモリ増えない
  - **時間**: 40–60分

- [ ] **pollfd 管理最適化**
  - **目的**: FD削除O(1)化 & ベクタ穴防止
  - **手順**: スワップ削除 + fd→indexマップ
  - **Done**: 多数接続で劣化無
  - **時間**: 20–30分

- [ ] **タイマー統合設計**
  - **目的**: 接続/CGI/書込みタイムアウトを一元管理
  - **手順**: 最小期限計算→poll timeout調整
  - **Done**: アイドル時CPU低負荷維持
  - **時間**: 30–45分

- [ ] **ログ拡張（アクセスログ）**
  - **目的**: 解析容易な簡易combined形式
  - **手順**: メソッド/パス/ステータス/バイト/処理ms
  - **Done**: 1行/リクエスト記録
  - **時間**: 20–30分

- [ ] **RFC細部: Host必須/制御文字検証**
  - **目的**: HTTP/1.1整合性
  - **手順**: Host無→400, 制御文字含有→400
  - **Done**: 異常入力拒否
  - **時間**: 20–30分

- [ ] **HTTPパイプライン(任意強化)**
  - **目的**: リクエスト先行送信対応
  - **手順**: 解析後キュー化 & 順次送信
  - **Done**: 複数連続送信が順序保持
  - **時間**: 40–60分

- [ ] **シグナル優雅終了 (SIGINT/SIGTERM)**
  - **目的**: リソース/子プロセス回収
  - **手順**: フラグ設定→ループ抜け→close/waitpid
  - **Done**: Ctrl+Cでクリーン終了
  - **時間**: 20–30分

- [ ] **E2Eテストスクリプト整備**
  - **目的**: 回帰テスト自動化
  - **手順**: curlケース, CGI, chunked, エラー
  - **Done**: 1コマンドで主要ケース緑
  - **時間**: 40–60分

- [ ] **アップロード/実行権限セキュリティ強化**
  - **目的**: 任意実行・拡張子悪用防止
  - **手順**: アップロード先権限制御, CGI対象拡張子限定
  - **Done**: 危険拡張子未実行
  - **時間**: 30–40分

